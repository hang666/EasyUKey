<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>EasyUKey 认证</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
		></script>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
		/>
		<style>
			@keyframes pulse-ring {
				0% {
					transform: translate(-50%, -50%) scale(0.7);
					opacity: 1;
				}
				100% {
					transform: translate(-50%, -50%) scale(1.3);
					opacity: 0;
				}
			}
			.pulse-ring::before {
				content: "";
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 100%;
				height: 100%;
				border: 2px solid #3b82f6;
				border-radius: 50%;
				animation: pulse-ring 2s infinite;
			}
			[x-cloak] {
				display: none !important;
			}
		</style>
	</head>
	<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
		<div
			x-data="authFlow({{.Remaining}}, '{{.RawRequest}}')"
			x-init="init()"
			class="min-h-screen flex items-center justify-center p-4"
		>
			<div
				class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative overflow-hidden"
			>
				<!-- 认证请求视图 -->
				<div x-show="!completed" x-cloak>
					<!-- 背景装饰 -->
					<div
						class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-400 to-indigo-600 rounded-full -translate-y-16 translate-x-16 opacity-10"
					></div>

					<!-- 标题区域 -->
					<div class="text-center mb-8">
						<div class="relative inline-block mb-4">
							<div
								class="w-20 h-20 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white text-3xl pulse-ring relative"
							>
								<i class="fas fa-shield-alt"></i>
							</div>
						</div>
						<h1 class="text-2xl font-bold text-gray-800 mb-2">EasyUKey 认证</h1>
						<p class="text-gray-600">请确认以下认证请求</p>
					</div>

					<!-- 认证信息卡片 -->
					<div class="bg-gray-50 rounded-xl p-6 mb-6">
						<div class="space-y-4">
							<!-- 用户信息 -->
							<div class="flex items-center">
								<div
									class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3"
								>
									<i class="fas fa-user text-blue-600"></i>
								</div>
								<div>
									<p class="text-sm text-gray-500">用户ID</p>
									<p class="font-semibold text-gray-800">{{.Request.UserID}}</p>
								</div>
							</div>
							<!-- 认证消息 -->
							<div class="flex items-center">
								<div
									class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3"
								>
									<i class="fas fa-info-circle text-green-600"></i>
								</div>
								<div>
									<p class="text-sm text-gray-500">认证消息</p>
									<p class="font-semibold text-gray-800">
										{{.Request.Message}}
									</p>
								</div>
							</div>
						</div>
					</div>

					<!-- 倒计时显示 -->
					<div
						class="bg-gradient-to-r from-orange-100 to-red-100 rounded-xl p-4 mb-6"
					>
						<div class="flex items-center justify-center">
							<div
								class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0"
							>
								<i class="fas fa-hourglass-half text-white text-sm"></i>
							</div>
							<div class="flex items-baseline space-x-1 text-orange-800">
								<p class="text-sm text-orange-700">请求将在</p>
								<p class="text-2xl font-bold" x-text="remaining"></p>
								<p class="text-lg">秒</p>
								<p class="text-sm text-orange-700">后过期</p>
							</div>
						</div>
						<div
							class="mt-3 w-full bg-orange-200 rounded-full h-2 overflow-hidden"
						>
							<div
								class="bg-gradient-to-r from-orange-400 to-red-500 h-2 rounded-full transition-all duration-1000"
								:style="'width: ' + (initialTime > 0 ? (remaining / initialTime * 100) : 0) + '%'"
							></div>
						</div>
					</div>

					<!-- 操作按钮 -->
					<div class="flex space-x-3">
						<button
							@click="submit('reject')"
							:disabled="expired || loading"
							class="flex-1 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 text-white font-semibold py-3 px-6 rounded-xl transition-colors duration-200 flex items-center justify-center"
						>
							<i class="fas fa-times mr-2"></i>
							拒绝
						</button>
						<button
							@click="submit('confirm')"
							:disabled="expired || loading"
							class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 disabled:from-gray-300 disabled:to-gray-400 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 flex items-center justify-center transform hover:scale-105"
						>
							<i class="fas fa-check mr-2"></i>
							确认认证
						</button>
					</div>

					<!-- 过期提示 -->
					<div
						x-show="expired"
						x-transition
						class="mt-4 p-4 bg-red-100 border border-red-200 rounded-lg text-center"
					>
						<p class="text-red-700 font-semibold">
							<i class="fas fa-exclamation-triangle mr-2"></i>
							认证请求已过期
						</p>
					</div>
				</div>

				<!-- 结果视图 -->
				<div x-show="completed" x-cloak class="text-center">
					<div class="mb-6">
						<div
							class="w-20 h-20 rounded-full flex items-center justify-center text-white text-3xl mx-auto mb-4"
							:class="confirmStatus === true ? 'bg-gradient-to-br from-green-500 to-emerald-600' : 'bg-gradient-to-br from-red-500 to-orange-600'"
						>
							<i
								class="fas"
								:class="confirmStatus === true ? 'fa-check' : 'fa-times'"
							></i>
						</div>
						<h1
							class="text-2xl font-bold text-gray-800 mb-2"
							x-text="resultStatus === 'success' ? '认证完成' : '认证失败'"
						></h1>
						<p class="text-lg text-gray-600" x-text="resultMessage"></p>
					</div>
					<div class="text-sm text-gray-500">
						<p>此窗口将在 5 秒后自动关闭</p>
					</div>
				</div>

				<!-- 全局加载状态 -->
				<div
					x-show="loading"
					x-transition
					class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center rounded-2xl"
				>
					<div class="text-center">
						<div
							class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"
						></div>
						<p class="text-gray-600">处理中...</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			function authFlow(initialRemaining, rawRequest) {
				return {
					initialTime: initialRemaining,
					remaining: initialRemaining,
					rawRequest: rawRequest,
					expired: initialRemaining <= 0,
					loading: false,
					completed: false,
					resultMessage: "",
					confirmStatus: "", // true or false
					resultStatus: "", // 'success' or 'error'

					init() {
						if (!this.expired) {
							this.startTimer();
						}
					},

					startTimer() {
						const interval = setInterval(() => {
							this.remaining--;
							if (this.remaining <= 0) {
								this.remaining = 0;
								this.expired = true;
								clearInterval(interval);
							}
						}, 1000);
					},

					async submit(action) {
						if (this.expired || this.loading) return;
						this.loading = true;

						try {
							const response = await fetch("/confirm", {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
								},
								body: JSON.stringify({
									action: action,
									request: this.rawRequest,
								}),
							});

							const result = await response.json();
							if (!response.ok) {
								throw new Error(result.message || "发生未知错误");
							}
							this.showResult(
								result.message,
								result.confirmStatus,
								result.status
							);
						} catch (error) {
							console.error("操作失败:", error);
							this.showResult(
								error.message || "操作失败，请重试",
								false,
								"error"
							);
						}
					},

					showResult(message, confirmStatus, resultStatus) {
						this.loading = false;
						this.completed = true;
						this.resultMessage = message;
						this.confirmStatus = confirmStatus;
						this.resultStatus = resultStatus;

						setTimeout(() => {
							window.close();
						}, 5000);
					},
				};
			}
		</script>
	</body>
</html>
